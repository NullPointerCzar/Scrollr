# Database Documentation

## Database Technology

**MongoDB** - NoSQL document database  
**ODM:** Mongoose 9.0.0

## Connection

**Configuration File:** `server/src/config/db.js`

```javascript
import mongoose from "mongoose";

const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGO_URI);
    console.log(`MongoDB Connected: ${conn.connection.host}`);
  } catch (error) {
    console.error(`Error: ${error.message}`);
    process.exit(1);
  }
};
```

**Connection String Format:**
```
mongodb+srv://username:password@cluster.mongodb.net/database?options
```

---

## Models

### User Model

**File:** `server/src/models/User.js`

**Collection Name:** `users`

**Schema Definition:**

```javascript
{
  username: {
    type: String,
    required: [true, "Username is required"],
    unique: true,
    trim: true,
    minlength: 3,
    maxlength: 30,
  },
  
  email: {
    type: String,
    required: [true, "Email is required"],
    unique: true,
    lowercase: true,
    trim: true,
  },
  
  password: {
    type: String,
    required: [true, "Password is required"],
    minlength: 6,
  },
  
  avatar: {
    type: String,
    default: "https://i.ibb.co/0jqHpnp/default-avatar.png",
  },
  
  bio: {
    type: String,
    maxlength: 160,
    default: "",
  },
  
  role: {
    type: String,
    enum: ["user", "admin"],
    default: "user",
  },
  
  followers: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: "User",
  }],
  
  following: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: "User",
  }],
  
  createdAt: Date,  // Auto-generated by timestamps
  updatedAt: Date,  // Auto-generated by timestamps
}
```

**Indexes:**
- `username` - Unique index
- `email` - Unique index

**Timestamps:** Enabled (automatically adds `createdAt` and `updatedAt`)

---

### User Model Methods

#### Instance Methods

**1. matchPassword(enteredPassword)**

Compares entered password with stored hashed password.

```javascript
userSchema.methods.matchPassword = async function (enteredPassword) {
  return await bcrypt.compare(enteredPassword, this.password);
};
```

**Parameters:**
- `enteredPassword` (String) - Plain text password to verify

**Returns:** Boolean - `true` if passwords match, `false` otherwise

**Usage:**
```javascript
const user = await User.findOne({ email });
const isMatch = await user.matchPassword("password123");
```

---

### Pre-Save Middleware

**Password Hashing**

Automatically hashes password before saving to database.

```javascript
userSchema.pre("save", async function () {
  if (!this.isModified("password")) return;
  
  const salt = await bcrypt.genSalt(10);
  this.password = await bcrypt.hash(this.password, salt);
});
```

**Behavior:**
- Only runs when password is modified
- Uses bcrypt with 10 salt rounds
- Runs before document is saved to database

---

## Field Details

### username
- **Type:** String
- **Required:** Yes
- **Unique:** Yes
- **Validation:** 3-30 characters
- **Indexed:** Yes
- **Trim:** Yes (removes whitespace)

### email
- **Type:** String
- **Required:** Yes
- **Unique:** Yes
- **Indexed:** Yes
- **Transform:** Lowercase
- **Trim:** Yes

### password
- **Type:** String
- **Required:** Yes
- **Validation:** Minimum 6 characters
- **Storage:** Hashed with bcrypt (never stored as plain text)
- **Hidden:** Excluded from queries using `.select("-password")`

### avatar
- **Type:** String (URL)
- **Required:** No
- **Default:** `https://i.ibb.co/0jqHpnp/default-avatar.png`
- **Purpose:** Profile picture URL

### bio
- **Type:** String
- **Required:** No
- **Default:** Empty string
- **Validation:** Maximum 160 characters
- **Purpose:** User biography/description

### role
- **Type:** String (Enum)
- **Required:** No
- **Default:** "user"
- **Allowed Values:** ["user", "admin"]
- **Purpose:** Role-based access control

### followers
- **Type:** Array of ObjectIds
- **Reference:** User model
- **Default:** Empty array
- **Purpose:** List of users following this user

### following
- **Type:** Array of ObjectIds
- **Reference:** User model
- **Default:** Empty array
- **Purpose:** List of users this user follows

### createdAt
- **Type:** Date
- **Auto-generated:** Yes (via timestamps)
- **Purpose:** Record creation timestamp

### updatedAt
- **Type:** Date
- **Auto-generated:** Yes (via timestamps)
- **Auto-updated:** Yes (on any document update)
- **Purpose:** Last modification timestamp

---

## Sample Documents

### Basic User Document
```json
{
  "_id": "674f8a1b2c3d4e5f6a7b8c9d",
  "username": "johndoe",
  "email": "john@example.com",
  "password": "$2a$10$XYZ123...",
  "avatar": "https://i.ibb.co/0jqHpnp/default-avatar.png",
  "bio": "",
  "role": "user",
  "followers": [],
  "following": [],
  "createdAt": "2024-12-03T10:30:00.000Z",
  "updatedAt": "2024-12-03T10:30:00.000Z"
}
```

### User with Bio and Connections
```json
{
  "_id": "674f8a1b2c3d4e5f6a7b8c9d",
  "username": "janedoe",
  "email": "jane@example.com",
  "password": "$2a$10$ABC789...",
  "avatar": "https://cloudinary.com/image/xyz.jpg",
  "bio": "Software developer | Coffee enthusiast â˜•",
  "role": "user",
  "followers": [
    "674f8a1b2c3d4e5f6a7b8c9e",
    "674f8a1b2c3d4e5f6a7b8c9f"
  ],
  "following": [
    "674f8a1b2c3d4e5f6a7b8ca0"
  ],
  "createdAt": "2024-12-01T08:15:00.000Z",
  "updatedAt": "2024-12-03T14:22:00.000Z"
}
```

---

## Future Models (Planned)

### Post Model (Coming Soon)
```javascript
{
  author: ObjectId (ref: User),
  content: String,
  images: [String],
  likes: [ObjectId (ref: User)],
  comments: [{
    user: ObjectId (ref: User),
    text: String,
    createdAt: Date
  }],
  createdAt: Date,
  updatedAt: Date
}
```

### Comment Model (Coming Soon)
```javascript
{
  post: ObjectId (ref: Post),
  user: ObjectId (ref: User),
  text: String,
  createdAt: Date,
  updatedAt: Date
}
```

### Notification Model (Coming Soon)
```javascript
{
  user: ObjectId (ref: User),
  type: String (enum: ['like', 'comment', 'follow']),
  from: ObjectId (ref: User),
  post: ObjectId (ref: Post),
  read: Boolean,
  createdAt: Date
}
```

---

## Database Operations

### Common Queries

**Find user by email:**
```javascript
const user = await User.findOne({ email: "john@example.com" });
```

**Find user by ID (excluding password):**
```javascript
const user = await User.findById(userId).select("-password");
```

**Create new user:**
```javascript
const user = await User.create({
  username: "johndoe",
  email: "john@example.com",
  password: "plainPassword123" // Will be hashed automatically
});
```

**Update user bio:**
```javascript
const user = await User.findByIdAndUpdate(
  userId,
  { bio: "New bio text" },
  { new: true } // Return updated document
);
```

**Follow a user:**
```javascript
// Add to following list
await User.findByIdAndUpdate(
  currentUserId,
  { $addToSet: { following: targetUserId } }
);

// Add to followers list
await User.findByIdAndUpdate(
  targetUserId,
  { $addToSet: { followers: currentUserId } }
);
```

**Unfollow a user:**
```javascript
// Remove from following list
await User.findByIdAndUpdate(
  currentUserId,
  { $pull: { following: targetUserId } }
);

// Remove from followers list
await User.findByIdAndUpdate(
  targetUserId,
  { $pull: { followers: currentUserId } }
);
```

**Get user with populated followers:**
```javascript
const user = await User.findById(userId)
  .populate('followers', 'username avatar')
  .populate('following', 'username avatar');
```

---

## Performance Considerations

### Indexes
- Ensure indexes on frequently queried fields (username, email)
- Consider compound indexes for complex queries
- Monitor index usage with MongoDB Atlas or `explain()`

### Query Optimization
- Use `.select()` to limit returned fields
- Use `.lean()` for read-only queries (returns plain JS objects)
- Implement pagination for large result sets
- Use aggregation pipeline for complex data transformations

### Example Optimized Query:
```javascript
const users = await User
  .find({ role: 'user' })
  .select('username avatar bio')
  .limit(20)
  .lean();
```

---

## Security Best Practices

1. **Password Storage:**
   - Never store plain text passwords
   - Use bcrypt with sufficient salt rounds (10+)
   - Password field excluded from default queries

2. **Data Validation:**
   - Mongoose schema validation
   - Additional validation in controllers
   - Sanitize user inputs

3. **Access Control:**
   - Role-based permissions (user/admin)
   - Verify ownership before updates
   - Use authentication middleware

4. **Sensitive Data:**
   - Exclude password from API responses
   - Don't expose internal fields (_id vs public id)
   - Limit data in error messages

---

## Backup and Recovery

### Recommended Practices:
- Enable MongoDB Atlas automated backups
- Regular manual exports for critical data
- Test restore procedures
- Store backups in multiple locations

### Manual Backup Command:
```bash
mongodump --uri="mongodb+srv://user:pass@cluster.mongodb.net/database"
```

### Manual Restore Command:
```bash
mongorestore --uri="mongodb+srv://user:pass@cluster.mongodb.net/database" dump/
```

---

## Monitoring

### Key Metrics to Monitor:
- Connection pool size
- Query execution time
- Index usage
- Database size
- Active connections

### MongoDB Atlas Features:
- Real-time performance metrics
- Query profiler
- Index recommendations
- Automated alerts
